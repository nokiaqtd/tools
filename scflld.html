<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCF-LLD</title>
  <script>
    // SVG-only favicon: white "N" on hsl(219 100% 50%) background
    (function(){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="64" height="64" role="img" aria-label="N">
        <rect width="100%" height="100%" fill="hsl(219 100% 50%)"/>
        <!-- left vertical bar -->
        <rect x="8" y="8" width="10" height="48" fill="#fff"/>
        <!-- diagonal stroke (slanted middle) -->
        <polygon points="18,8 30,8 46,56 34,56" fill="#fff"/>
        <!-- right vertical bar -->
        <rect x="46" y="8" width="10" height="48" fill="#fff"/>
      </svg>`;

      const url = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
      document.querySelectorAll('link[rel~="icon"]').forEach(n => n.remove());
      const link = document.createElement('link');
      link.rel = 'icon';
      link.type = 'image/svg+xml';
      link.href = url;
      document.head.appendChild(link);
    })();
  </script>
  <style>
    html, body { margin: 0; height: 100%; }
    iframe { border: none; width: 100%; height: 100%; touch-action: auto; -ms-touch-action: auto; pointer-events: auto; -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>
  <!-- initial src intentionally left blank. script below decides whether to set it. -->
  <iframe id="ndbFrame"
    src=""
    allow="clipboard-read; clipboard-write self https://script.google.com; geolocation; microphone; camera; accelerometer; gyroscope; autoplay">
  </iframe>

  <script>
    (function(){
      // === CONFIGURE IFRAME URL HERE ===
      const IFRAME_BASE_URL = 'https://script.google.com/macros/s/AKfycbwAzQerQPBggqxl0vDwVz_vvHmBQcOY_aORMtd2V8yx-3clhqCk7ULSZ7TcYm6gMpwF/exec';
      const LS_KEY = 'scflld';

      // preserve parent's query string when forwarding to iframe
      const pageQS = location.search || ''; // includes leading '?' when present
      const iframeSrc = IFRAME_BASE_URL + (pageQS ? (IFRAME_BASE_URL.includes('?') ? '&' + pageQS.slice(1) : pageQS) : '');

      const frame = document.getElementById('ndbFrame');

      // LocalStorage logic:
      // - if scflld not exist -> set to "1" and load iframe
      // - if exists -> increment by 1, save; if new value < 3 then load iframe; otherwise do nothing
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw === null) {
          // not present: create with value 1 and load iframe
          localStorage.setItem(LS_KEY, '1');
          window.location.href = iframeSrc;
        } else {
          // present: increment by 1
          let n = parseInt(raw, 10);
          if (Number.isNaN(n)) n = 0;
          n = n + 1;
          localStorage.setItem(LS_KEY, String(n));
          // if new value < 3 then load iframe, otherwise do nothing
          if (n <= 3) {
            window.location.href = iframeSrc;
          } else {
            // do nothing: leave iframe unloaded (or keep whatever src it already has)
            // If you prefer to load iframe when n >= 3 instead, change the condition above.
            console.log(`localStorage.${LS_KEY} = ${n}; iframe load skipped (>= 3)`);
          }
        }
      } catch (err) {
        // localStorage may be unavailable in some contexts (e.g., privacy mode) -> fail-safe: load iframe
        console.warn('localStorage check failed, loading iframe as fallback:', err);
        frame.src = iframeSrc;
      }

      // Keep document title in sync (redundant with <title> but explicit)
      document.title = 'SCF-LLD';
    })();
  </script>

  <script>
    // allow only the trusted iframe origin(s)
    const TRUSTED_IFRAME_ORIGINS = [
      'https://script.google.com'
      // add other origins if you host the iframe elsewhere
    ];
  
    window.addEventListener('message', async (ev) => {
      // validate origin
      if (!TRUSTED_IFRAME_ORIGINS.some(o => ev.origin.startsWith(o))) return;
      const msg = ev.data || {};
      if (msg && msg.type === 'ndb-copy') {
        try {
          // do the clipboard write in the top-level context (must be secure context)
          await navigator.clipboard.writeText(msg.text || '');
          // reply success
          ev.source.postMessage({ type: 'ndb-copy-result', ok: true, id: msg.id || null }, ev.origin);
        } catch (err) {
          // reply failure
          ev.source.postMessage({ type: 'ndb-copy-result', ok: false, err: String(err), id: msg.id || null }, ev.origin);
        }
      }
    }, false);
  </script>
</body>
</html>
